<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å”å¤è¯—ç©¿è¶Šè®° - AIè¯—è¯å…»æˆæ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.loli.net/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8B4513;
            --secondary-color: #DAA520;
            --text-color: #333;
            --bg-color: #F5F5DC;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ccc" opacity="0.3"/><circle cx="75" cy="75" r="1" fill="%23ccc" opacity="0.3"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }
        
        .title-font {
            font-family: 'Ma Shan Zheng', cursive;
        }
        
        .subtitle-font {
            font-family: 'ZCOOL XiaoWei', serif;
        }
        
        .ancient-border {
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.95);
        }
        
        .poetry-card {
            border: 2px solid var(--secondary-color);
            border-radius: 6px;
            background: linear-gradient(135deg, #FFF8DC 0%, #FFFACD 100%);
            padding: 16px;
            margin: 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-ancient {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .btn-ancient:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .btn-ancient:active {
            transform: translateY(0);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .chronicle-item {
            border-left: 3px solid var(--secondary-color);
            padding-left: 12px;
            margin: 12px 0;
        }
        
        .stat-bar {
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), #B8860B);
            transition: width 0.5s ease;
        }
        
        .hidden { display: none !important; }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid var(--primary-color);
            z-index: 100;
        }
        
        .nav-btn {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .nav-btn:hover {
            background: var(--bg-color);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #B8860B 100%);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen pb-20">
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="startScreen" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="ancient-border p-8 max-w-md w-full text-center">
            <h1 class="title-font text-5xl mb-4" style="color: var(--primary-color);">å¤§å”å¤è¯—ç©¿è¶Šè®°</h1>
            <p class="subtitle-font text-xl mb-6" style="color: var(--secondary-color);">ç©¿è¶Šé•¿å®‰ï¼Œè¯—é…’é£æµ</p>
            
            <div id="newGameForm" class="space-y-4">
                <div class="text-left">
                    <label class="block mb-2 font-semibold">ä½ çš„å§“å</label>
                    <input type="text" id="playerName" placeholder="è¯·è¾“å…¥å§“åï¼ˆå¦‚ï¼šæ—æ¸…ç…§ï¼‰" 
                           class="w-full p-3 border-2 rounded-lg focus:border-amber-500 outline-none">
                </div>
                
                <div class="text-left">
                    <label class="block mb-2 font-semibold">æ€§åˆ«</label>
                    <select id="playerGender" class="w-full p-3 border-2 rounded-lg">
                        <option value="å¥³">å¥³</option>
                        <option value="ç”·">ç”·</option>
                    </select>
                </div>
                
                <button onclick="startGame()" class="btn-ancient w-full text-lg">
                    å¼€å§‹ç©¿è¶Š
                </button>
            </div>
            
            <div id="loadingMessage" class="hidden mt-4">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p>æ­£åœ¨ç©¿è¶Šåˆ°é•¿å®‰åŸ...</p>
            </div>
        </div>
    </div>
    
    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div id="gameScreen" class="hidden">
        <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
        <div class="ancient-border m-4 p-4">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="title-font text-2xl" style="color: var(--primary-color);" id="gameTitle">å¤©å®å…ƒå¹´æ˜¥</h2>
                    <p class="subtitle-font text-lg" style="color: var(--secondary-color);" id="currentLocation">é•¿å®‰åŸ</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">æ–‡é‡‡ <span id="literaryTalent">30</span>/100</p>
                    <p class="text-sm text-gray-600">å£°æœ› <span id="reputation">0</span></p>
                    <p class="text-sm text-gray-600">è¯—ç¨¿ <span id="poetryCount">0</span>ç¯‡</p>
                </div>
            </div>
        </div>
        
        <!-- ä¸»è§’ä¿¡æ¯å¡ -->
        <div class="ancient-border m-4 p-4">
            <div class="flex items-center space-x-4">
                <div class="w-20 h-20 rounded-full bg-amber-100 flex items-center justify-center text-3xl" id="avatarPlaceholder">
                    ğŸ‘©
                </div>
                <div class="flex-1">
                    <h3 class="title-font text-xl" id="protagonistName">æœªå‘½å</h3>
                    <p class="text-sm text-gray-600" id="protagonistIdentity">æ¸¸å­¦æ‰å¥³</p>
                    <div class="mt-2">
                        <p class="text-xs text-gray-500 mb-1">æ–‡é‡‡</p>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" id="literaryTalentBar" style="width: 30%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¿«æ·æ“ä½œ -->
        <div class="grid grid-cols-4 gap-2 mx-4 mb-4">
            <button onclick="openCreationModal()" class="btn-ancient text-sm py-2">
                ğŸ“ åˆ›ä½œ
            </button>
            <button onclick="organizePoetryParty()" class="btn-ancient text-sm py-2">
                ğŸ è¯—ä¼š
            </button>
            <button onclick="takeExamAction()" class="btn-ancient text-sm py-2">
                ğŸ“œ ç§‘ä¸¾
            </button>
            <button onclick="nextMonthAction()" class="btn-ancient text-sm py-2">
                ğŸ“… ä¸‹æœˆ
            </button>
        </div>
        
        <!-- å½“å‰äº‹ä»¶ -->
        <div class="ancient-border m-4 p-4">
            <h3 class="subtitle-font text-lg mb-3" style="color: var(--primary-color);">æœ¬æœˆè¯—å…´</h3>
            <div id="currentEvents" class="space-y-3">
                <p class="text-gray-500 text-center">æš‚æ— è¯—å…´äº‹ä»¶</p>
            </div>
        </div>
        
        <!-- è¯—ç¨¿æ”¶è— -->
        <div class="ancient-border m-4 p-4">
            <h3 class="subtitle-font text-lg mb-3" style="color: var(--primary-color);">è¯—ç¨¿æ”¶è—</h3>
            <div id="poetryCollection" class="space-y-2 max-h-60 overflow-y-auto">
                <p class="text-gray-500 text-center">æš‚æ— è¯—ç¨¿</p>
            </div>
        </div>
    </div>
    
    <!-- æ–‡äººåˆ—è¡¨ç•Œé¢ -->
    <div id="poetsScreen" class="hidden pb-20">
        <div class="ancient-border m-4 p-4">
            <h2 class="title-font text-2xl mb-4" style="color: var(--primary-color);">é•¿å®‰æ–‡äºº</h2>
            <div id="poetsList" class="space-y-3">
                <!-- æ–‡äººå¡ç‰‡å°†åŠ¨æ€æ’å…¥ -->
            </div>
        </div>
        <button onclick="showTab('home')" class="fixed bottom-20 right-4 btn-ancient">
            è¿”å›
        </button>
    </div>
    
    <!-- è®°äº‹ç•Œé¢ -->
    <div id="recordsScreen" class="hidden pb-20">
        <div class="ancient-border m-4 p-4">
            <h2 class="title-font text-2xl mb-4" style="color: var(--primary-color);">æ¸¸å†è®°äº‹</h2>
            <div id="chroniclesList" class="space-y-3 max-h-screen overflow-y-auto pb-20">
                <!-- è®°äº‹å°†åŠ¨æ€æ’å…¥ -->
            </div>
        </div>
        <button onclick="showTab('home')" class="fixed bottom-20 right-4 btn-ancient">
            è¿”å›
        </button>
    </div>
    
    <!-- è®¾ç½®ç•Œé¢ -->
    <div id="settingsScreen" class="hidden pb-20">
        <div class="ancient-border m-4 p-4">
            <h2 class="title-font text-2xl mb-4" style="color: var(--primary-color);">âš™ï¸ è®¾ç½®</h2>

            <!-- é™æ€æ‰˜ç®¡æç¤º -->
            <div class="mb-4 p-3 bg-green-50 border-l-4 border-green-500 rounded">
                <p class="text-sm text-green-800">
                    <strong>âœ… éƒ¨ç½²åœ¨ GitHub Pages</strong><br>
                    æ— éœ€ Pythonï¼Œé€šè¿‡ HTTPS ç›´æ¥è®¿é—®ï¼Œç¨³å®šå¯é ã€‚
                </p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block mb-2 font-semibold">API åœ°å€</label>
                    <input type="text" id="apiBaseUrl" placeholder="https://api.openai.com/v1"
                           class="w-full p-3 border-2 rounded-lg focus:border-amber-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">ä¾‹å¦‚ï¼šhttps://api.openai.com/v1 æˆ– https://api.code-relay.com/v1</p>
                </div>

                <div>
                    <label class="block mb-2 font-semibold">API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-..."
                           class="w-full p-3 border-2 rounded-lg focus:border-amber-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">ä½ çš„ API å¯†é’¥ï¼ˆæ”¯æŒ OpenAIã€Anthropic ç­‰ï¼‰</p>
                </div>

                <div>
                    <label class="block mb-2 font-semibold">æ¨¡å‹</label>
                    <div class="flex space-x-2">
                        <select id="modelSelect" class="flex-1 p-3 border-2 rounded-lg">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turboï¼ˆæ¨èï¼‰</option>
                            <option value="gpt-4">GPT-4ï¼ˆè´¨é‡æ›´é«˜ï¼Œæˆæœ¬æ›´é«˜ï¼‰</option>
                        </select>
                        <button onclick="fetchModels()" id="fetchModelsBtn"
                                class="btn-ancient px-4 text-sm whitespace-nowrap" title="è·å–å¯ç”¨æ¨¡å‹">
                            ğŸ“¥ è·å–
                        </button>
                    </div>
                    <p id="modelFetchStatus" class="text-xs text-gray-500 mt-1"></p>
                </div>

                <div id="connectionStatus" class="p-3 rounded-lg text-sm bg-gray-100">
                    <span class="font-semibold">è¿æ¥çŠ¶æ€ï¼š</span>
                    <span id="connectionText">æœªæµ‹è¯•</span>
                </div>

                <button onclick="saveSettings()" class="btn-ancient w-full mb-2">
                    ğŸ’¾ ä¿å­˜è®¾ç½®
                </button>

                <button onclick="testConnection()" id="testBtn"
                        class="btn-ancient w-full" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
                    ğŸ”Œ æµ‹è¯•è¿æ¥
                </button>

                <div class="border-t pt-4 mt-4">
                    <h3 class="font-semibold mb-3">å­˜æ¡£ç®¡ç†</h3>
                    <button onclick="exportSave()" class="btn-ancient w-full mb-2">
                        ğŸ“¤ å¯¼å‡ºå­˜æ¡£
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="btn-ancient w-full mb-2">
                        ğŸ“¥ å¯¼å…¥å­˜æ¡£
                    </button>
                    <input type="file" id="importFile" accept=".json" class="hidden" onchange="importSave(this)">
                    <button onclick="resetGame()" class="btn-ancient w-full bg-red-700" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                        ğŸ”„ é‡æ–°å¼€å§‹
                    </button>
                </div>

                <div class="border-t pt-4 mt-4">
                    <h3 class="font-semibold mb-2">ä½¿ç”¨è¯´æ˜</h3>
                    <ul class="text-xs text-gray-600 space-y-1">
                        <li>â€¢ ç›´æ¥åŒå‡» HTML æ–‡ä»¶å³å¯è¿è¡Œ</li>
                        <li>â€¢ æ‰€æœ‰ API è¯·æ±‚é€šè¿‡ CORS ä»£ç†ä¸­è½¬</li>
                        <li>â€¢ ä»£ç†å¯èƒ½ä¼šç¨å¾®å¢åŠ å“åº”æ—¶é—´</li>
                        <li>â€¢ é¦–æ¬¡è¿è¡Œå»ºè®®ç‚¹å‡»"æµ‹è¯•è¿æ¥"</li>
                    </ul>
                </div>
            </div>
        </div>
        <button onclick="showTab('home')" class="fixed bottom-20 right-4 btn-ancient">
            è¿”å›
        </button>
    </div>
    
    <!-- åˆ›ä½œæ¨¡æ€æ¡† -->
    <div id="creationModal" class="modal-overlay hidden">
        <div class="modal-content max-w-lg">
            <h2 class="title-font text-2xl mb-4" style="color: var(--primary-color);">ğŸ“ è¯—è¯åˆ›ä½œ</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 font-semibold">è¯—ä½“</label>
                    <select id="poetryType" class="w-full p-3 border-2 rounded-lg">
                        <option value="äº”è¨€ç»å¥">äº”è¨€ç»å¥ï¼ˆ20å­—ï¼‰</option>
                        <option value="ä¸ƒè¨€ç»å¥">ä¸ƒè¨€ç»å¥ï¼ˆ28å­—ï¼‰</option>
                        <option value="äº”è¨€å¾‹è¯—">äº”è¨€å¾‹è¯—ï¼ˆ40å­—ï¼‰</option>
                        <option value="ä¸ƒè¨€å¾‹è¯—">ä¸ƒè¨€å¾‹è¯—ï¼ˆ56å­—ï¼‰</option>
                    </select>
                </div>
                
                <div>
                    <label class="block mb-2 font-semibold">è¾“å…¥è¯—å¥ï¼ˆå‰åŠéƒ¨åˆ†ï¼‰</label>
                    <textarea id="playerInput" rows="3" placeholder="ä¾‹å¦‚ï¼šåºŠå‰æ˜æœˆå…‰" 
                              class="w-full p-3 border-2 rounded-lg focus:border-amber-500 outline-none"></textarea>
                    <p class="text-xs text-gray-500 mt-1">AI å°†è‡ªåŠ¨è¡¥å…¨ååŠéƒ¨åˆ†</p>
                </div>
                
                <button onclick="completePoetryAction()" class="btn-ancient w-full">
                    âœ¨ çµéŸµè¡¥å…¨
                </button>
                <button onclick="closeModal('creationModal')" class="btn-ancient w-full" style="background: #666;">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- è¯—ä¼šç»“æœæ¨¡æ€æ¡† -->
    <div id="partyResultModal" class="modal-overlay hidden">
        <div class="modal-content max-w-2xl">
            <h2 class="title-font text-2xl mb-4" style="color: var(--primary-color);">ğŸ è¯—ä¼šé›…é›†</h2>
            <div id="partyResultContent" class="space-y-4">
                <!-- è¯—ä¼šç»“æœå°†åŠ¨æ€æ’å…¥ -->
            </div>
            <button onclick="closeModal('partyResultModal')" class="btn-ancient w-full mt-4">
                å…³é—­
            </button>
        </div>
    </div>
    
    <!-- è€ƒè¯•ç»“æœæ¨¡æ€æ¡† -->
    <div id="examResultModal" class="modal-overlay hidden">
        <div class="modal-content max-w-lg">
            <h2 class="title-font text-2xl mb-4" style="color: var(--primary-color);">ğŸ“œ ç§‘ä¸¾è€ƒè¯•</h2>
            <div id="examResultContent" class="space-y-4">
                <!-- è€ƒè¯•ç»“æœå°†åŠ¨æ€æ’å…¥ -->
            </div>
            <button onclick="closeModal('examResultModal')" class="btn-ancient w-full mt-4">
                å…³é—­
            </button>
        </div>
    </div>
    
    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="modal-overlay hidden">
        <div class="text-center text-white">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p id="loadingText" class="text-xl">æ­£åœ¨ç”Ÿæˆ...</p>
            <p class="text-sm mt-2 text-gray-300">è¯·ç¨å€™ï¼ŒAI æ­£åœ¨åˆ›ä½œè¯—è¯</p>
        </div>
    </div>
    
    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <div class="flex">
            <button onclick="showTab('home')" class="nav-btn active" id="navHome">
                <div class="text-2xl">ğŸ </div>
                <div class="text-xs">ä¸»é¡µ</div>
            </button>
            <button onclick="showTab('poets')" class="nav-btn" id="navPoets">
                <div class="text-2xl">ğŸ‘¥</div>
                <div class="text-xs">æ–‡äºº</div>
            </button>
            <button onclick="showTab('records')" class="nav-btn" id="navRecords">
                <div class="text-2xl">ğŸ“š</div>
                <div class="text-xs">è®°äº‹</div>
            </button>
            <button onclick="showTab('settings')" class="nav-btn" id="navSettings">
                <div class="text-2xl">âš™ï¸</div>
                <div class="text-xs">è®¾ç½®</div>
            </button>
        </div>
    </div>

    <script src="tang_poetry_game.js"></script>
    <script>
        // ==================== æ¸¸æˆé€»è¾‘ ====================
        
        // ç­‰å¾…è„šæœ¬åŠ è½½å®Œæˆåè·å–å‡½æ•°
        let gameFunctions = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…æ¸¸æˆè„šæœ¬...');
            
            // æ£€æŸ¥æ¸¸æˆè„šæœ¬æ˜¯å¦åŠ è½½
            setTimeout(() => {
                if (window.tangPoetryGame) {
                    gameFunctions = window.tangPoetryGame;
                    console.log('æ¸¸æˆå‡½æ•°åŠ è½½æˆåŠŸ:', Object.keys(gameFunctions));
                    loadSavedGame();
                } else {
                    console.error('æ¸¸æˆè„šæœ¬æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ tang_poetry_game.js æ–‡ä»¶');
                    alert('æ¸¸æˆè„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿ tang_poetry_game.js æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹');
                }
            }, 100);
        });
        
        // è·å–æ¸¸æˆå‡½æ•°
        function getGameFunctions() {
            if (!gameFunctions) {
                gameFunctions = window.tangPoetryGame;
                if (!gameFunctions) {
                    throw new Error('æ¸¸æˆå‡½æ•°æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
                }
            }
            return gameFunctions;
        }
        
        // åŠ è½½å­˜æ¡£
        function loadSavedGame() {
            try {
                const functions = getGameFunctions();
                if (functions.loadGameData()) {
                    currentGameData = functions.getGameData();
                    showGameScreen();
                    updateUI();
                }
            } catch (error) {
                console.error('åŠ è½½å­˜æ¡£å¤±è´¥:', error);
            }
        }
        
        // å¼€å§‹æ–°æ¸¸æˆ
        async function startGame() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('è¯·è¾“å…¥å§“å');
                return;
            }
            
            const gender = document.getElementById('playerGender').value;
            
            document.getElementById('newGameForm').classList.add('hidden');
            document.getElementById('loadingMessage').classList.remove('hidden');
            
            try {
                const functions = getGameFunctions();
                await functions.startNewGame(playerName, gender);
                currentGameData = functions.getGameData();
                showGameScreen();
                updateUI();
            } catch (error) {
                console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
                alert('å¼€å§‹æ¸¸æˆå¤±è´¥ï¼š' + error.message);
                document.getElementById('newGameForm').classList.remove('hidden');
                document.getElementById('loadingMessage').classList.add('hidden');
            }
        }
        
        // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
        function showGameScreen() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
        }
        
        // æ›´æ–°UI
        function updateUI() {
            if (!currentGameData) return;
            
            const { protagonist, world, poetryCollection } = currentGameData;
            
            // æ›´æ–°é¡¶éƒ¨ä¿¡æ¯
            document.getElementById('gameTitle').textContent = `${world.yearTitle}${world.year}å¹´${world.season}`;
            document.getElementById('currentLocation').textContent = world.currentLocation;
            document.getElementById('literaryTalent').textContent = protagonist.stats.literaryTalent;
            document.getElementById('reputation').textContent = protagonist.stats.reputation;
            document.getElementById('poetryCount').textContent = protagonist.poetryCount || 0;
            
            // æ›´æ–°ä¸»è§’ä¿¡æ¯
            document.getElementById('protagonistName').textContent = protagonist.name;
            document.getElementById('protagonistIdentity').textContent = protagonist.identity;
            document.getElementById('avatarPlaceholder').textContent = protagonist.gender === 'å¥³' ? 'ğŸ‘©' : 'ğŸ‘¨';
            
            // æ›´æ–°æ–‡é‡‡è¿›åº¦æ¡
            document.getElementById('literaryTalentBar').style.width = protagonist.stats.literaryTalent + '%';
            
            // æ›´æ–°è¯—ç¨¿æ”¶è—
            updatePoetryCollection();
            
            // æ›´æ–°æ–‡äººåˆ—è¡¨
            updatePoetsList();
            
            // æ›´æ–°è®°äº‹
            updateChronicles();
        }
        
        // æ›´æ–°è¯—ç¨¿æ”¶è—
        function updatePoetryCollection() {
            const container = document.getElementById('poetryCollection');
            const poems = currentGameData.poetryCollection || [];
            
            if (poems.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— è¯—ç¨¿</p>';
                return;
            }
            
            container.innerHTML = poems.slice(-10).reverse().map(poem => `
                <div class="poetry-card">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-amber-700 font-semibold">${poem.type}</span>
                        <span class="text-xs text-gray-500">${poem.date.yearTitle}${poem.date.year}å¹´${poem.date.month}æœˆ</span>
                    </div>
                    <h4 class="font-bold mb-1" style="color: var(--primary-color);">${poem.title}</h4>
                    <p class="text-center my-2 leading-loose">${poem.content}</p>
                    ${poem.commentary ? `<p class="text-xs text-gray-600 mt-2">${poem.commentary}</p>` : ''}
                    ${poem.author ? `<p class="text-xs text-gray-500 text-right">â€” ${poem.author}</p>` : ''}
                </div>
            `).join('');
        }
        
        // æ›´æ–°æ–‡äººåˆ—è¡¨
        function updatePoetsList() {
            const container = document.getElementById('poetsList');
            const poets = currentGameData.characters.filter(c => c.isPoet) || [];
            
            if (poets.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— æ–‡äºº</p>';
                return;
            }
            
            container.innerHTML = poets.map(poet => `
                <div class="poetry-card">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center text-xl">
                            ${poet.gender === 'å¥³' ? 'ğŸ‘©' : 'ğŸ‘¨'}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold" style="color: var(--primary-color);">${poet.name}</h4>
                            <p class="text-sm text-gray-600">${poet.courtesyName || ''} Â· ${poet.identity}</p>
                            <p class="text-xs text-gray-500">${poet.poetryStyle}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-amber-700">æ–‡é‡‡ ${poet.literaryTalent}</p>
                            <p class="text-sm text-amber-700">å£°æœ› ${poet.reputation}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // æ›´æ–°è®°äº‹
        function updateChronicles() {
            const container = document.getElementById('chroniclesList');
            const chronicles = currentGameData.chronicles || [];
            
            if (chronicles.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— è®°äº‹</p>';
                return;
            }
            
            container.innerHTML = chronicles.slice(-20).reverse().map(item => `
                <div class="chronicle-item">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-amber-700">${item.date.yearTitle}${item.date.year}å¹´${item.date.month}æœˆ</span>
                        <span class="text-xs text-gray-500">${item.type}</span>
                    </div>
                    <p class="text-sm whitespace-pre-line">${item.content}</p>
                </div>
            `).join('');
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tab) {
            // éšè—æ‰€æœ‰ç•Œé¢
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('poetsScreen').classList.add('hidden');
            document.getElementById('recordsScreen').classList.add('hidden');
            document.getElementById('settingsScreen').classList.add('hidden');
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæŒ‰é’®çš„ active ç±»
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            // æ˜¾ç¤ºå¯¹åº”ç•Œé¢å’Œæ¿€æ´»å¯¼èˆªæŒ‰é’®
            if (tab === 'home') {
                document.getElementById('gameScreen').classList.remove('hidden');
                document.getElementById('navHome').classList.add('active');
            } else if (tab === 'poets') {
                document.getElementById('poetsScreen').classList.remove('hidden');
                document.getElementById('navPoets').classList.add('active');
            } else if (tab === 'records') {
                document.getElementById('recordsScreen').classList.remove('hidden');
                document.getElementById('navRecords').classList.add('active');
            } else if (tab === 'settings') {
                document.getElementById('settingsScreen').classList.remove('hidden');
                document.getElementById('navSettings').classList.add('active');
                
                // å¡«å……è®¾ç½®
                document.getElementById('apiBaseUrl').value = currentGameData.settings.apiBaseUrl || '';
                document.getElementById('apiKey').value = currentGameData.settings.apiKey || '';
                document.getElementById('modelSelect').value = currentGameData.settings.model || 'gpt-3.5-turbo';
            }
        }
        
        // æ‰“å¼€åˆ›ä½œæ¨¡æ€æ¡†
        function openCreationModal() {
            document.getElementById('creationModal').classList.remove('hidden');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // æ˜¾ç¤ºåŠ è½½
        function showLoading(text = 'æ­£åœ¨ç”Ÿæˆ...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        // éšè—åŠ è½½
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        // è¯—è¯åˆ›ä½œ
        async function completePoetryAction() {
            const userInput = document.getElementById('playerInput').value.trim();
            const poetryType = document.getElementById('poetryType').value;
            
            if (!userInput) {
                alert('è¯·è¾“å…¥è¯—å¥');
                return;
            }
            
            closeModal('creationModal');
            showLoading('æ­£åœ¨è¡¥å…¨è¯—å¥...');
            
            try {
                const functions = getGameFunctions();
                const result = await functions.completePoetry(userInput, poetryType);
                currentGameData = functions.getGameData();
                updateUI();
                alert('âœ… è¡¥å…¨æˆåŠŸï¼\n\n' + result.playerLines + '\n' + result.aiLines);
            } catch (error) {
                console.error('è¡¥å…¨å¤±è´¥:', error);
                alert('âŒ è¡¥å…¨å¤±è´¥ï¼š' + error.message);
            }
            
            hideLoading();
        }
        
        // ç»„ç»‡è¯—ä¼š
        async function organizeParty() {
            if (!currentGameData.settings.apiKey || !currentGameData.settings.apiBaseUrl) {
                alert('è¯·å…ˆåœ¨"è®¾ç½®"ä¸­é…ç½® API\n\nç‚¹å‡»åº•éƒ¨å¯¼èˆªæ çš„ âš™ï¸ è®¾ç½®');
                showTab('settings');
                return;
            }

            showLoading('æ­£åœ¨ç»„ç»‡è¯—ä¼š...');

            try {
                const functions = getGameFunctions();
                const result = await functions.organizePoetryParty();
                currentGameData = functions.getGameData();
                updateUI();
                
                // æ˜¾ç¤ºè¯—ä¼šç»“æœ
                const content = document.getElementById('partyResultContent');
                content.innerHTML = `
                    <p class="mb-3">${result.partyDescription}</p>
                    <div class="text-center mb-4 p-4" style="background: var(--bg-color); border-radius: 8px;">
                        <span class="text-lg" style="color: var(--secondary-color);">ğŸ† é­é¦–</span>
                        <h3 class="title-font text-3xl mt-2" style="color: var(--primary-color);">${result.champion}</h3>
                        <p class="text-sm text-gray-600 mt-1">${result.championReason}</p>
                    </div>
                    <div class="space-y-2">
                        ${result.participants.map(p => `
                            <div class="poetry-card">
                                <div class="flex justify-between">
                                    <span class="font-bold">${p.name}ï¼ˆç¬¬${p.ranking}åï¼‰</span>
                                    <span class="text-sm text-amber-700">å£°æœ›${p.reputationChange > 0 ? '+' : ''}${p.reputationChange}</span>
                                </div>
                                <h4 class="font-bold">ã€Š${p.poemTitle}ã€‹</h4>
                                <p class="text-center my-2">${p.poemContent}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('partyResultModal').classList.remove('hidden');
            } catch (error) {
                console.error('è¯—ä¼šå¤±è´¥:', error);
                alert('âŒ è¯—ä¼šå¤±è´¥ï¼š' + error.message);
            }
            
            hideLoading();
        }
        
        // å‚åŠ è€ƒè¯•
        async function takeExamAction() {
            if (!currentGameData.settings.apiKey || !currentGameData.settings.apiBaseUrl) {
                alert('è¯·å…ˆåœ¨"è®¾ç½®"ä¸­é…ç½® API\n\nç‚¹å‡»åº•éƒ¨å¯¼èˆªæ çš„ âš™ï¸ è®¾ç½®');
                showTab('settings');
                return;
            }
            
            const examType = currentGameData.world.month <= 6 ? 'è¿›å£«ç§‘' : 'æ˜ç»ç§‘';
            showLoading(`æ­£åœ¨å‚åŠ ${examType}...`);
            
            try {
                const functions = getGameFunctions();
                const result = await functions.takeExam(examType);
                currentGameData = functions.getGameData();
                updateUI();
                
                // æ˜¾ç¤ºè€ƒè¯•ç»“æœ
                const content = document.getElementById('examResultContent');
                const gradeColors = {
                    'ä¸€ç”²': '#FFD700',
                    'äºŒç”²': '#C0C0C0',
                    'ä¸‰ç”²': '#CD7F32',
                    'è½æ¦œ': '#999'
                };
                
                content.innerHTML = `
                    <p class="mb-3">${result.examQuestion}</p>
                    <div class="text-center mb-4 p-4" style="background: var(--bg-color); border-radius: 8px;">
                        <span class="text-lg" style="color: var(--secondary-color);">ç­‰ç¬¬</span>
                        <h3 class="title-font text-4xl mt-2" style="color: ${gradeColors[result.grade] || '#333'};">${result.grade}</h3>
                        <p class="text-sm text-gray-600 mt-1">${result.gradeReason}</p>
                    </div>
                    <div class="poetry-card">
                        <h4 class="font-bold text-center mb-2">ã€Š${result.poemTitle}ã€‹</h4>
                        <p class="text-center my-2">${result.poemContent}</p>
                        <p class="text-sm text-gray-600 mt-2">è€ƒå®˜è¯„è¯­ï¼š${result.examinerComment}</p>
                    </div>
                    ${result.careerAdvancement ? `<p class="text-center mt-4 text-lg p-3 rounded" style="color: var(--secondary-color); background: var(--bg-color);">ğŸ‰ è·å¾—å®˜èŒï¼š${result.newTitle}</p>` : ''}
                `;
                document.getElementById('examResultModal').classList.remove('hidden');
            } catch (error) {
                console.error('è€ƒè¯•å¤±è´¥:', error);
                alert('âŒ è€ƒè¯•å¤±è´¥ï¼š' + error.message);
            }
            
            hideLoading();
        }
        
        // ä¸‹ä¸ªæœˆ
        async function nextMonthAction() {
            showLoading('æ—¶é—´æµé€ä¸­...');
            
            try {
                const functions = getGameFunctions();
                await functions.nextMonth();
                currentGameData = functions.getGameData();
                updateUI();
                alert('âœ… æ—¶é—´æ¨è¿›æˆåŠŸï¼');
            } catch (error) {
                console.error('æ¨è¿›æ—¶é—´å¤±è´¥:', error);
                alert('âŒ æ¨è¿›æ—¶é—´å¤±è´¥ï¼š' + error.message);
            }
            
            hideLoading();
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelSelect').value;
            
            if (!apiBaseUrl || !apiKey) {
                alert('è¯·å¡«å†™å®Œæ•´çš„ API é…ç½®ä¿¡æ¯');
                return;
            }
            
            const functions = getGameFunctions();
            functions.updateSettings({
                apiBaseUrl: apiBaseUrl,
                apiKey: apiKey,
                model: model
            });
            
            currentGameData = functions.getGameData();
            alert('âœ… è®¾ç½®å·²ä¿å­˜ï¼');
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const functions = getGameFunctions();
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            const testBtn = document.getElementById('testBtn');
            
            testBtn.disabled = true;
            testBtn.textContent = 'â³ æµ‹è¯•ä¸­...';
            statusText.textContent = 'æµ‹è¯•ä¸­...';
            statusDiv.className = 'p-3 rounded-lg text-sm bg-blue-100';
            
            try {
                const result = await functions.testAPIConnection();
                
                if (result.success) {
                    statusText.textContent = 'âœ… ' + result.message;
                    statusDiv.className = 'p-3 rounded-lg text-sm bg-green-100';
                } else {
                    statusText.textContent = 'âŒ ' + result.message;
                    statusDiv.className = 'p-3 rounded-lg text-sm bg-red-100';
                }
            } catch (error) {
                statusText.textContent = 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message;
                statusDiv.className = 'p-3 rounded-lg text-sm bg-red-100';
            }
            
            testBtn.disabled = false;
            testBtn.textContent = 'ğŸ”Œ æµ‹è¯•è¿æ¥';
        }
        
        // è·å–å¯ç”¨æ¨¡å‹
        async function fetchModels() {
            const functions = getGameFunctions();
            const statusText = document.getElementById('modelFetchStatus');
            const fetchBtn = document.getElementById('fetchModelsBtn');
            const modelSelect = document.getElementById('modelSelect');
            
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'â³';
            statusText.textContent = 'æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...';
            
            try {
                const result = await functions.fetchAvailableModels();
                
                if (result.success && result.models.length > 0) {
                    // æ¸…ç©ºå¹¶é‡æ–°å¡«å……æ¨¡å‹åˆ—è¡¨
                    modelSelect.innerHTML = result.models.map(model => 
                        `<option value="${model}">${model}</option>`
                    ).join('');
                    
                    // é€‰ä¸­å½“å‰ä½¿ç”¨çš„æ¨¡å‹
                    if (currentGameData.settings.model) {
                        modelSelect.value = currentGameData.settings.model;
                    }
                    
                    statusText.textContent = `âœ… æˆåŠŸè·å– ${result.models.length} ä¸ªæ¨¡å‹`;
                    statusText.className = 'text-xs text-green-600 mt-1';
                } else {
                    statusText.textContent = result.message;
                    statusText.className = 'text-xs text-orange-600 mt-1';
                }
            } catch (error) {
                statusText.textContent = 'âŒ è·å–å¤±è´¥: ' + error.message;
                statusText.className = 'text-xs text-red-600 mt-1';
            }
            
            fetchBtn.disabled = false;
            fetchBtn.textContent = 'ğŸ“¥ è·å–';
        }
        
        // å¯¼å‡ºå­˜æ¡£
        function exportSave() {
            try {
                const functions = getGameFunctions();
                functions.exportGameData();
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // å¯¼å…¥å­˜æ¡£
        function importSave(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const functions = getGameFunctions();
                functions.importGameData(file).then(() => {
                    currentGameData = functions.getGameData();
                    updateUI();
                    alert('âœ… å¯¼å…¥æˆåŠŸï¼');
                }).catch(error => {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                });
            } catch (error) {
                alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // é‡æ–°å¼€å§‹
        function resetGame() {
            if (confirm('âš ï¸ ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿ\n\næ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼Œæ— æ³•æ¢å¤ã€‚')) {
                localStorage.removeItem('tangPoetryGame');
                location.reload();
            }
        }
    </script>
</body>
</html>
